<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Troop - Transporte Seguro e Confiável</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&family=Audiowide&display=swap" rel="stylesheet">
    
    <!-- Custom Styles & Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'troop-purple': '#322275',
                        'troop-light-gray': '#F5F5F5',
                        'troop-dark-gray': '#333333',
                        'troop-white': '#FFFFFF',
                        'muted': '#E5E7EB',
                        'muted-foreground': '#6B7280',
                    },
                    fontFamily: {
                        'lato': ['Lato', 'sans-serif'],
                        'horizon': ['Audiowide', 'cursive'],
                    },
                    boxShadow: {
                        'strong': '0 10px 25px -5px rgba(0, 0, 0, 0.2), 0 8px 10px -6px rgba(0, 0, 0, 0.2)',
                    },
                    height: {
                        '128': '32rem', // 512px
                    }
                }
            }
        }
    </script>
    <style>
        .bg-gradient-overlay {
            /* Overlay com transparência ajustada para tornar a imagem mais visível */
            background-image: linear-gradient(to top, rgba(50, 34, 117, 0.75) 0%, rgba(50, 34, 117, 0.3) 60%, rgba(50, 34, 117, 0.1) 100%);
        }
        /* For date input placeholder */
        input[type="date"]:not(:valid):before {
            content: attr(placeholder);
            color: #6B7280;
        }
    </style>
    <!-- API do Google Maps (Places + Geometry para cálculos de distância) -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCu47mjnadIRWMqFq1lPw_qEBz6Ns3Ic7s&libraries=places,geometry"></script>
</head>
<body class="font-lato bg-troop-white text-troop-dark-gray">

    <!-- Header -->
    <header class="absolute top-0 left-0 right-0 z-50 bg-transparent">
        <nav class="container mx-auto px-6 py-4 flex items-center justify-between">
            <!-- Logo -->
            <div id="header-logo" class="flex items-center space-x-4">
                <div class="relative flex items-center justify-center h-14 w-14 md:h-16 md:w-16 bg-troop-white/90 rounded-2xl shadow-2xl">
                    <img src="https://img.icons8.com/?size=100&id=QTQ1x0Wu6rnn&format=png&color=000000" alt="Van Escolar" class="h-10 w-10 md:h-12 md:w-12 object-contain drop-shadow-xl" />
                </div>
                <span class="font-horizon font-black text-3xl md:text-4xl text-troop-white drop-shadow-xl tracking-wide hidden sm:inline">Troop</span>
            </div>
            <!-- Navigation -->
            <div class="hidden md:flex items-center">
                <a id="header-login" href="#" class="ml-2 bg-gradient-to-r from-troop-white/80 to-troop-purple/30 border border-troop-white/40 text-troop-purple hover:bg-troop-white hover:text-troop-purple font-bold py-2 px-6 rounded-full shadow-lg transition-all duration-200 text-base scale-105">Login</a>
            </div>
            <!-- Mobile menu button -->
            <div class="md:hidden flex items-center">
                <button class="p-2 rounded-full bg-troop-white/20 hover:bg-troop-white/40 transition shadow-lg border border-troop-white/30 flex items-center justify-center" aria-label="Abrir menu">
                    <svg class="h-7 w-7 text-troop-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 8h16M4 16h16"/></svg>
                </button>
            </div>
        </nav>
    </header>

        <!-- Hero Section: aumente o layout da primeira página -->
<section class="relative min-h-[80vh] flex items-center justify-center overflow-hidden pt-16 pb-10">
    <!-- Background Image (van escolar) com blur -->
    <div class="absolute inset-0 bg-cover bg-center bg-no-repeat blur-[2px] bg-[url('https://przewozosobnysa.pl/wp-content/uploads/2024/06/ludzie-wchodzacy-do-busa.jpg')]"></div>
    <!-- Overlay para transparência e cor troop-purple mais forte -->
    <div class="absolute inset-0 bg-gradient-to-tr from-troop-purple/80 via-troop-purple/60 to-troop-purple/30"></div>

    <!-- Content -->
    <div class="relative z-10 container mx-auto px-10">
        <div id="etapa-1">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-12 items-center max-w-5xl mx-auto">
                <!-- Card com campos (lado esquerdo) -->
                <div class="bg-troop-white/95 backdrop-blur-sm shadow-strong border-0 p-10 md:p-16 rounded-3xl">
                    <div class="space-y-6 mb-10">
                        <p class="text-sm md:text-base font-semibold text-troop-dark-gray mb-2">Descubra rotas seguras para o seu destino agora</p>
                        <div class="grid md:grid-cols-1 gap-6">
                            <div class="relative">
                                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-muted-foreground" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                                <input id="partida" placeholder="Digite seu endereço (ex: Rua das Flores, 123)" class="pl-10 h-12 w-full border-2 border-muted rounded-md focus:border-troop-purple focus:ring-0">
                            </div>
                            <div class="relative">
                                    <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-muted-foreground" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                                    <select id="destino" class="pl-10 h-12 w-full border-2 border-muted rounded-md focus:border-troop-purple focus:ring-0 appearance-none bg-white text-troop-dark-gray">
                                        <option value="" disabled selected hidden>Escolha a rota</option>
                                    </select>
                                </div>
                                <!-- Third field removed as requested -->
                            </div>
                        </div>
                        <button id="btn-etapa-1" class="w-full bg-troop-purple text-troop-white font-bold py-2 px-4 rounded-lg shadow-lg transform hover:scale-105 flex items-center justify-center text-base transition-all duration-300 hover:shadow-xl">
                            <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                            BUSCAR ROTAS
                        </button>
                    </div>
                    <!-- Título (lado direito) -->
                    <div class="text-right md:pl-4">
                        <h1 class="font-lato font-black text-3xl md:text-4xl text-troop-white mb-8 md:mb-12 leading-relaxed md:leading-[1.2] tracking-normal md:tracking-wide drop-shadow-lg">
                            O transporte para suas atividades,<br>
                            <span class="inline-block mt-4 mb-4"></span>
                            com a <span class="text-troop-purple bg-troop-white/80 px-2 rounded">segurança e confiança</span><br>
                            <span class="inline-block mt-4 mb-4"></span>
                            que você precisa.
                        </h1>
                    </div>
                </div>
            </div>
            <div id="etapa-2" class="hidden bg-troop-light-gray">
                <!-- Dashboard de comparação: barra de busca + mapa + lista -->
                <section class="h-screen flex flex-col">
                    <!-- Barra de busca compacta (top bar) -->
                    <div class="shrink-0 border-b border-gray-200 bg-troop-white/90 backdrop-blur-md">
                        <div class="max-w-6xl mx-auto px-4 py-3 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                            <div class="flex flex-col md:flex-row md:items-baseline gap-1">
                                <span class="font-horizon text-lg text-troop-purple tracking-wide">Comparar rotas</span>
                                <span class="text-xs text-muted-foreground md:ml-2">Ajuste sua busca sem sair da tela.</span>
                            </div>
                            <form id="results-search-form" class="grid grid-cols-1 md:grid-cols-[minmax(0,2fr)_minmax(0,2fr)_auto] gap-2 w-full md:max-w-3xl">
                                <div class="relative">
                                    <label for="results-origin" class="sr-only">Origem</label>
                                    <input id="results-origin" type="text" placeholder="Origem" class="w-full h-10 rounded-lg border border-muted px-3 pl-9 text-xs md:text-sm text-troop-dark-gray focus:outline-none focus:ring-2 focus:ring-troop-purple/50 focus:border-troop-purple bg-white/90" />
                                    <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12S4 16 4 10a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                                </div>
                                <div class="relative">
                                    <label for="results-destino" class="sr-only">Destino</label>
                                    <select id="results-destino" class="w-full h-10 rounded-lg border border-muted px-3 pl-9 text-xs md:text-sm text-troop-dark-gray focus:outline-none focus:ring-2 focus:ring-troop-purple/50 focus:border-troop-purple bg-white/90 appearance-none">
                                        <option value="" disabled selected hidden>Destino</option>
                                    </select>
                                    <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12S4 16 4 10a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                                    <svg class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                                </div>
                                <div class="flex items-stretch gap-2">
                                    <div class="relative flex-1">
                                        <label for="results-date" class="sr-only">Data</label>
                                        <input id="results-date" type="date" class="w-full h-10 rounded-lg border border-muted px-3 text-xs md:text-sm text-troop-dark-gray focus:outline-none focus:ring-2 focus:ring-troop-purple/50 focus:border-troop-purple bg-white/90" />
                                    </div>
                                    <button type="submit" class="inline-flex items-center justify-center h-10 px-4 rounded-lg bg-troop-purple text-troop-white text-xs md:text-sm font-semibold shadow-md hover:bg-troop-purple/90 transition-colors whitespace-nowrap">
                                        <svg class="h-4 w-4 mr-1.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                                        Atualizar busca
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Área principal: mapa + barra lateral -->
                    <div class="flex-1 flex flex-col md:flex-row">
                        <!-- Mapa (esquerda no desktop) -->
                        <div id="results-map-shell" class="relative md:w-7/12 lg:w-2/3 h-[40vh] md:h-full bg-gray-100">
                            <div id="map" class="absolute inset-0"></div>
                            <!-- Botão flutuante de recentralizar -->
                            <button id="btn-recentralizar" class="absolute bottom-4 right-4 inline-flex items-center gap-1.5 rounded-full bg-troop-white/95 text-troop-dark-gray text-xs font-semibold shadow-lg px-3 py-1.5 border border-gray-200 hover:bg-troop-white">
                                <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v5h.01"/><path d="M7 3h5"/><path d="M3 7v5"/><path d="M21 3v5h-.01"/><path d="M17 3h-5"/><path d="M21 7v5"/><path d="M3 21v-5h.01"/><path d="M7 21h5"/><path d="M3 17v-5"/><path d="M21 21v-5h-.01"/><path d="M17 21h-5"/><path d="M21 17v-5"/><circle cx="12" cy="12" r="3"/></svg>
                                Recentralizar
                            </button>
                            <!-- A legenda das vans será injetada aqui via JS -->
                        </div>

                        <!-- Barra lateral de motoristas (direita no desktop) -->
                        <aside class="md:w-5/12 lg:w-1/3 h-[60vh] md:h-full bg-troop-white border-t md:border-t-0 md:border-l border-gray-200 flex flex-col">
                            <!-- Cabeçalho + filtros rápidos -->
                            <div class="px-4 pt-4 pb-3 border-b border-gray-200">
                                <div class="flex items-center justify-between mb-3">
                                    <div>
                                        <h2 class="font-semibold text-sm text-troop-dark-gray">Comparar motoristas</h2>
                                        <p class="text-xs text-muted-foreground">Filtre por preço, avaliação e vagas.</p>
                                    </div>
                                    <span id="drivers-count" class="text-[11px] px-2 py-0.5 rounded-full bg-troop-light-gray text-muted-foreground"></span>
                                </div>
                                <div id="driver-filters" class="flex flex-wrap gap-2">
                                    <button type="button" data-filter="" class="filter-pill inline-flex items-center px-3 py-1 rounded-full text-[11px] font-semibold bg-troop-purple text-troop-white shadow-sm">Todos</button>
                                    <button type="button" data-filter="cheapest" class="filter-pill inline-flex items-center px-3 py-1 rounded-full text-[11px] font-semibold bg-troop-light-gray text-troop-dark-gray hover:bg-muted">Mais barata</button>
                                    <button type="button" data-filter="rating" class="filter-pill inline-flex items-center px-3 py-1 rounded-full text-[11px] font-semibold bg-troop-light-gray text-troop-dark-gray hover:bg-muted">Melhor avaliada</button>
                                    <button type="button" data-filter="seats" class="filter-pill inline-flex items-center px-3 py-1 rounded-full text-[11px] font-semibold bg-troop-light-gray text-troop-dark-gray hover:bg-muted">Vagas disponíveis</button>
                                </div>
                            </div>

                            <!-- Lista de motoristas / estado vazio -->
                            <div id="drivers-list" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
                        </aside>
                    </div>
                </section>
            </div>
            <div id="etapa-3" class="hidden">
                <!-- Confirmação/agendamento -->
                <div class="max-w-xl mx-auto bg-troop-white rounded-xl shadow-lg p-8 text-center">
                    <h2 class="font-horizon text-3xl text-troop-dark-gray mb-4">Confirmação</h2>
                    <p class="mb-6">Sua rota foi selecionada! Complete o agendamento abaixo.</p>
                    <!-- Adicione campos de confirmação/agendamento conforme necessário -->
                    <button class="bg-troop-purple text-troop-white font-bold py-3 px-6 rounded-lg shadow-lg mt-4">Finalizar Agendamento</button>
                </div>
            </div>
        </div>
    </div>
</section>

    <main>
        <!-- How It Works Section -->
        <section id="como-funciona" class="py-3 bg-troop-light-gray">
    <div class="container mx-auto px-2 text-center">
        <h2 class="font-horizon text-xl md:text-2xl text-troop-dark-gray mb-2">Simples, Rápido e Confiável</h2>
        <p class="max-w-md mx-auto text-muted-foreground mb-4 text-sm">Em apenas três passos você organiza seu transporte com total segurança.</p>
        <div class="grid md:grid-cols-3 gap-3">
            <div class="flex flex-col items-center p-2 rounded-md">
                <div class="bg-troop-purple/10 text-troop-purple p-2 rounded-full mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                </div>
                <h3 class="font-bold text-base mb-1">1. Busque o trajeto ideal</h3>
                <p class="text-muted-foreground text-xs">Encontre a rota perfeita para suas necessidades.</p>
            </div>
            <div class="flex flex-col items-center p-2 rounded-md">
                <div class="bg-troop-purple/10 text-troop-purple p-2 rounded-full mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                </div>
                <h3 class="font-bold text-base mb-1">2. Escolha o melhor plano</h3>
                <p class="text-muted-foreground text-xs">Selecione entre opções diárias, semanais ou mensais.</p>
            </div>
            <div class="flex flex-col items-center p-2 rounded-md">
                <div class="bg-troop-purple/10 text-troop-purple p-2 rounded-full mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                </div>
                <h3 class="font-bold text-base mb-1">3. Agende com segurança</h3>
                <p class="text-muted-foreground text-xs">Confirme sua viagem com total tranquilidade.</p>
            </div>
        </div>
    </div>
</section>
        <!-- Pricing Section -->
        <section id="planos" class="py-20 bg-troop-light-gray hidden">
            <div class="container mx-auto px-6 text-center">
                <h2 class="font-horizon text-3xl md:text-4xl text-troop-dark-gray mb-4">Planos feitos para a sua rotina</h2>
                <p class="max-w-2xl mx-auto text-muted-foreground mb-12">Escolha o plano que melhor se adequa às suas necessidades e economize.</p>
                <div class="grid lg:grid-cols-3 gap-8 max-w-6xl mx-auto">
                    <!-- Plano Diário -->
                    <div class="bg-troop-white rounded-xl shadow-lg p-8 flex flex-col text-left transition-transform hover:-translate-y-2">
                        <h3 class="font-horizon text-2xl mb-2">Diário</h3>
                        <p class="text-muted-foreground mb-6">Perfeito para uso esporádico.</p>
                        <p class="text-4xl font-bold mb-1">R$25<span class="text-lg font-normal text-muted-foreground">/dia</span></p>
                        <ul class="space-y-3 text-troop-dark-gray my-8 flex-grow">
                            <li class="flex items-center"><svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Viagem ida e volta</li>
                            <li class="flex items-center"><svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Suporte durante a viagem</li>
                            <li class="flex items-center"><svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Seguro incluído</li>
                            <li class="flex items-center"><svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Flexibilidade total</li>
                        </ul>
                        <a href="#" class="selecionar-plano w-full text-center bg-troop-purple/10 text-troop-purple font-bold py-3 px-4 rounded-lg hover:bg-troop-purple/20 transition-colors">Selecionar</a>
                    </div>
                    <!-- Plano Mensal (Destaque) -->
                    <div class="bg-troop-purple text-troop-white rounded-xl shadow-strong p-8 flex flex-col text-left transition-transform hover:-translate-y-2 relative overflow-hidden">
                        <div class="absolute top-0 right-0 m-2 bg-troop-white/20 text-troop-white text-xs font-bold px-3 py-1 rounded-full">Melhor Custo-Benefício</div>
                        <h3 class="font-horizon text-2xl mb-2">Mensal</h3>
                        <p class="text-troop-white/80 mb-6">Melhor custo-benefício.</p>
                        <p class="text-4xl font-bold mb-1">R$380<span class="text-lg font-normal text-troop-white/80">/mês</span></p>
                        <ul class="space-y-3 my-8 flex-grow">
                            <li class="flex items-center"><svg class="w-5 h-5 text-green-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Viagens ilimitadas</li>
                            <li class="flex items-center"><svg class="w-5 h-5 text-green-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Suporte VIP 24/7</li>
                            <li class="flex items-center"><svg class="w-5 h-5 text-green-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Seguro premium+</li>
                            <li class="flex items-center"><svg class="w-5 h-5 text-green-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Desconto de 50%</li>
                            <li class="flex items-center"><svg class="w-5 h-5 text-green-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Prioridade na reserva</li>
                            <li class="flex items-center"><svg class="w-5 h-5 text-green-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>App exclusivo</li>
                        </ul>
                        <a href="#" class="selecionar-plano w-full text-center bg-troop-white text-troop-purple font-bold py-3 px-4 rounded-lg hover:bg-gray-200 transition-colors">Escolher Plano</a>
                    </div>
                    <!-- Plano Semanal -->
                    <div class="bg-troop-white rounded-xl shadow-lg p-8 flex flex-col text-left transition-transform hover:-translate-y-2">
                        <div class="absolute top-0 right-0 m-4 bg-troop-purple/10 text-troop-purple text-xs font-bold px-3 py-1 rounded-full">Economia</div>
                        <h3 class="font-horizon text-2xl mb-2">Semanal</h3>
                        <p class="text-muted-foreground mb-6">Economia para uso regular.</p>
                        <p class="text-4xl font-bold mb-1">R$120<span class="text-lg font-normal text-muted-foreground">/semana</span></p>
                        <ul class="space-y-3 text-troop-dark-gray my-8 flex-grow">
                            <li class="flex items-center"><svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Todas as viagens da semana</li>
                            <li class="flex items-center"><svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Suporte prioritário</li>
                            <li class="flex items-center"><svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Seguro premium</li>
                            <li class="flex items-center"><svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Desconto de 30%</li>
                            <li class="flex items-center"><svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Flexibilidade de horários</li>
                        </ul>
                        <a href="#" class="selecionar-plano w-full text-center bg-troop-purple/10 text-troop-purple font-bold py-3 px-4 rounded-lg hover:bg-troop-purple/20 transition-colors">Selecionar</a>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-troop-dark-gray text-troop-white">
        <div class="container mx-auto px-6 py-12">
            <div class="grid md:grid-cols-3 gap-8 text-center md:text-left">
                <div class="flex flex-col items-center md:items-start">
                    <div class="flex items-center space-x-3 mb-4">
    <script>
document.addEventListener("DOMContentLoaded", function () {
    // Lista de motoristas por rota será preenchida dinamicamente com dados reais do backend
    const motoristasPorRota = [];

    let partidaCoords = null;
    let map, marker, directionsService, directionsRenderer, polylines = [];
    // Contexto de onde o login foi aberto ("header" ou "buscar")
    let loginFlowContext = null;

    // CEP detection removed; destination options are populated based on the `partida` field.

    // Google Places Autocomplete para os campos de partida (etapa 1 e etapa 2)
    const partidaInput = document.getElementById('partida');
    const resultsOriginInput = document.getElementById('results-origin');

    let autocomplete = null;
    let autocompleteResults = null;

    if (partidaInput) {
        autocomplete = new google.maps.places.Autocomplete(partidaInput, {
            types: ['address'], // Permite endereços completos incluindo nomes de ruas
            componentRestrictions: { country: 'br' }
        });
        autocomplete.addListener('place_changed', function () {
            const place = autocomplete.getPlace();
            if (!place.geometry) return;
            partidaCoords = {
                lat: place.geometry.location.lat(),
                lng: place.geometry.location.lng()
            };

            // Mostra o endereço completo selecionado no campo de partida
            partidaInput.value = place.formatted_address;
            if (resultsOriginInput) resultsOriginInput.value = place.formatted_address;

            // Remove qualquer extração manual do bairro!
            let bairroDiv = document.getElementById('bairro-partida');
            if (bairroDiv) bairroDiv.remove();

            // Atualiza as origens das vans para ficarem próximas ao endereço de partida
            motoristasPorRota.forEach((rotaObj, idx) => {
                const offset = 0.003 + idx * 0.0015;
                rotaObj.origem = {
                    lat: partidaCoords.lat + (Math.random() - 0.5) * offset,
                    lng: partidaCoords.lng + (Math.random() - 0.5) * offset
                };
            });

            // Se o mapa já foi inicializado, recentra no novo endereço com zoom ideal para o círculo de 1km
            if (map) {
                map.setCenter(partidaCoords);
                map.setZoom(14); // Zoom ideal para visualizar círculo de 1km
            }
            // After selecting a place, update destination options from backend by city
            updateDestinoOptions().catch(err => console.error('Erro atualizando destinos:', err));
        });
    }

    if (resultsOriginInput) {
        autocompleteResults = new google.maps.places.Autocomplete(resultsOriginInput, {
            types: ['address'],
            componentRestrictions: { country: 'br' }
        });
        autocompleteResults.addListener('place_changed', function () {
            const place = autocompleteResults.getPlace();
            if (!place.geometry) return;
            partidaCoords = {
                lat: place.geometry.location.lat(),
                lng: place.geometry.location.lng()
            };

            resultsOriginInput.value = place.formatted_address;
            if (partidaInput) partidaInput.value = place.formatted_address;

            motoristasPorRota.forEach((rotaObj, idx) => {
                const offset = 0.003 + idx * 0.0015;
                rotaObj.origem = {
                    lat: partidaCoords.lat + (Math.random() - 0.5) * offset,
                    lng: partidaCoords.lng + (Math.random() - 0.5) * offset
                };
            });

            if (map) {
                map.setCenter(partidaCoords);
                map.setZoom(14);
            }

            // Atualiza a lista de destinos da etapa-2 usando a mesma lógica da etapa-1
            const destinoSelect = document.getElementById('results-destino');
            if (destinoSelect) {
                updateDestinoOptionsFor(resultsOriginInput, destinoSelect, autocompleteResults)
                    .catch(err => console.error('Erro atualizando destinos (etapa 2):', err));
            }
        });
    }

    // Utility: calcula distância (km) entre dois pontos
    function haversineKm(a, b) {
        function toRad(x) { return x * Math.PI / 180; }
        const R = 6371; // km
        const dLat = toRad(b.lat - a.lat);
        const dLon = toRad(b.lng - a.lng);
        const lat1 = toRad(a.lat);
        const lat2 = toRad(b.lat);
        const sinDlat = Math.sin(dLat/2);
        const sinDlon = Math.sin(dLon/2);
        const aa = sinDlat*sinDlat + Math.cos(lat1)*Math.cos(lat2)*sinDlon*sinDlon;
        const c = 2 * Math.atan2(Math.sqrt(aa), Math.sqrt(1-aa));
        return R * c;
    }

    // Geocodifica um endereço em coordenadas (Promise)
    function geocodeAddress(address) {
        return new Promise((resolve) => {
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ address }, function(results, status) {
                if (status === 'OK' && results[0]) {
                    const loc = results[0].geometry.location;
                    resolve({ lat: loc.lat(), lng: loc.lng() });
                } else {
                    resolve(null);
                }
            });
        });
    }

    // Get city/locality from an address using Google Geocoder (returns string or null)
    function getCityFromAddress(address) {
        return new Promise((resolve) => {
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ address }, function(results, status) {
                if (status === 'OK' && results && results.length) {
                    for (const r of results) {
                        for (const comp of r.address_components) {
                            if (comp.types.includes('locality') || comp.types.includes('administrative_area_level_2')) {
                                resolve(comp.long_name);
                                return;
                            }
                        }
                    }
                }
                resolve(null);
            });
        });
    }

    // Short label helper: take the first segment before a comma
    function shortLabel(full) {
        if (!full || typeof full !== 'string') return full || '';
        return full.split(',')[0].trim();
    }

    // Fetch routes from backend where origin or destination contains the city.
    async function fetchRoutesByCity(city) {
        console.log('[troop] fetchRoutesByCity called with city:', city);
        if (!city) return [];
        try {
            const results = [];
            // Try using API helper if available
            if (window.troopApi && typeof window.troopApi.fetchRoutes === 'function') {
                // origin
                const a = await window.troopApi.fetchRoutes({ origin: city, published: true });
                // destination
                const b = await window.troopApi.fetchRoutes({ destination: city, published: true });
                if (a && a.routes) results.push(...a.routes);
                else if (Array.isArray(a)) results.push(...a);
                if (b && b.routes) results.push(...b.routes);
                else if (Array.isArray(b)) results.push(...b);
            } else {
                const enc = encodeURIComponent(city);
                const a = await fetch(`/routes?origin=${enc}&published=true`);
                const ar = await a.json();
                if (ar && ar.routes) results.push(...ar.routes);
                else if (Array.isArray(ar)) results.push(...ar);
                const d = await fetch(`/routes?destination=${enc}&published=true`);
                const dr = await d.json();
                if (dr && dr.routes) results.push(...dr.routes);
                else if (Array.isArray(dr)) results.push(...dr);
            }
            // Deduplicate by id or by origin+destination+departureAt
            const seen = new Map();
            results.forEach(r => {
                const key = r.id ? String(r.id) : `${r.origin}|${r.destination}|${r.departureAt}`;
                if (!seen.has(key)) seen.set(key, r);
            });
            console.log('[troop] fetchRoutesByCity results count:', results.length);
            return Array.from(seen.values());
        } catch (err) {
            console.error('Erro ao buscar rotas por cidade:', err);
            return [];
        }
    }

    // Atualiza opções do select `destino` usando rotas vindas do backend (função genérica)
    async function updateDestinoOptionsFor(originInputEl, destinoSelectEl, autocompleteInstance) {
        if (!destinoSelectEl || !originInputEl) return;

        const partidaVal = originInputEl.value && originInputEl.value.trim();
        const prevValue = destinoSelectEl.value || null;
        destinoSelectEl.innerHTML = '';

        if (!partidaVal) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.disabled = true;
            opt.selected = true;
            opt.textContent = 'Insira um endereço no campo anterior';
            destinoSelectEl.appendChild(opt);
            return;
        }

        // determine city from the selected place (if available) or geocode the address
        let city = null;
        try {
            const place = autocompleteInstance && autocompleteInstance.getPlace && autocompleteInstance.getPlace();
            if (place && place.address_components) {
                for (const comp of place.address_components) {
                    if (comp.types.includes('locality') || comp.types.includes('administrative_area_level_2')) {
                        city = comp.long_name; break;
                    }
                }
            }
        } catch (e) { /* ignore */ }

        if (!city) {
            city = await getCityFromAddress(partidaVal);
        }

        // Debugging/logging: show what we determined
        console.log('[troop] partidaVal:', partidaVal);
        try { console.log('[troop] autocompleteInstance.getPlace():', autocompleteInstance && autocompleteInstance.getPlace && autocompleteInstance.getPlace()); } catch(e) {}
        console.log('[troop] determined city from components/geocode:', city);

        // Quick fallback: if the address text contains 'pelotas', assume Pelotas
        if (!city && partidaVal && partidaVal.toLowerCase().includes('pelotas')) {
            city = 'Pelotas';
            console.log('[troop] applied fallback city =>', city);
        }

        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.disabled = true;
        placeholder.selected = true;
        placeholder.hidden = true;
        placeholder.textContent = 'Escolha a rota';
        destinoSelectEl.appendChild(placeholder);

        if (!city) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.disabled = true;
            opt.selected = true;
            opt.textContent = 'Não foi possível identificar a cidade do endereço';
            destinoSelectEl.appendChild(opt);
            return;
        }

        const routes = await fetchRoutesByCity(city);
        console.log('[troop] routes fetched for select population:', routes && routes.length);
        if (!routes || routes.length === 0) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.disabled = true;
            opt.selected = true;
            opt.textContent = 'Nenhuma rota encontrada para essa cidade';
            destinoSelectEl.appendChild(opt);
            return;
        }
        // Build a list of display entries: include routes that have full origin+destination coords
        // and also include each stop as a separate entry (origin -> stop) when the stop has coords.
        const entries = [];
        for (const r of routes) {
            const originLat = r.originLat ?? (r.origin && r.origin.lat) ?? null;
            const originLng = r.originLng ?? (r.origin && r.origin.lng) ?? null;
            const destLat = r.destinationLat ?? (r.destination && r.destination.lat) ?? null;
            const destLng = r.destinationLng ?? (r.destination && r.destination.lng) ?? null;

            const hasOriginCoords = originLat !== null && originLng !== null && isFinite(Number(originLat)) && isFinite(Number(originLng));
            const hasDestCoords = destLat !== null && destLng !== null && isFinite(Number(destLat)) && isFinite(Number(destLng));

            // Only include the full route if both origin and destination have coordinates
            if (hasOriginCoords && hasDestCoords) {
                entries.push({
                    key: r.id ? String(r.id) : `${r.origin}|${r.destination}|${r.departureAt}`,
                    origin: r.origin || '',
                    destination: r.destination || '',
                    departureAt: r.departureAt || '',
                    originLat: Number(originLat),
                    originLng: Number(originLng),
                    destinationLat: Number(destLat),
                    destinationLng: Number(destLng),
                    sourceRouteId: r.id || null
                });
            }

            // If route has stops, include each stop as a separate selectable "route" (origin -> stop)
            if (Array.isArray(r.stops) && r.stops.length) {
                for (const s of r.stops) {
                    const sLat = s.lat ?? null;
                    const sLng = s.lng ?? null;
                    if (sLat !== null && sLng !== null && isFinite(Number(sLat)) && isFinite(Number(sLng)) && hasOriginCoords) {
                        entries.push({
                            key: r.id ? `${r.id}-stop-${s.id}` : `${r.origin}|${s.address}|${r.order}`,
                            origin: r.origin || '',
                            destination: s.address || s.name || '',
                            departureAt: r.departureAt || '',
                            originLat: Number(originLat),
                            originLng: Number(originLng),
                            destinationLat: Number(sLat),
                            destinationLng: Number(sLng),
                            sourceRouteId: r.id || null,
                            stopId: s.id || null
                        });
                    }
                }
            }
        }

        // Deduplicate entries by key and then append to select
        const seen = new Set();
        for (const e of entries) {
            if (!e || !e.key) continue;
            if (seen.has(e.key)) continue;
            seen.add(e.key);
            const opt = document.createElement('option');
            opt.value = e.key;
            opt.dataset.origin = e.origin || '';
            opt.dataset.destination = e.destination || '';
            opt.dataset.departure = e.departureAt || '';
            // Only show origin and destination in the option label (no dates or extra metadata)
            opt.textContent = `${shortLabel(e.origin)} → ${shortLabel(e.destination)}`;
            destinoSelectEl.appendChild(opt);
        }
        // restore previous selection when possible
        if (prevValue) {
            const match = Array.from(destinoSelectEl.options).find(o => o.value === prevValue);
            if (match) match.selected = true;
        }
        // trigger change to update selected summary if the select already has a value
        try { destinoSelectEl.dispatchEvent(new Event('change')); } catch (e) {}
    }

    // Versão específica da etapa-1, para manter compatibilidade
    async function updateDestinoOptions() {
        const select = document.getElementById('destino');
        return updateDestinoOptionsFor(partidaInput, select, autocomplete);
    }

    // Attach listeners: when focar/clicar em destino (etapa 1), atualiza opções
    const destinoSelect = document.getElementById('destino');
    destinoSelect.addEventListener('focus', updateDestinoOptions);
    // When the user selects a route, show a clear summary under the select
    destinoSelect.addEventListener('change', function () {
        const sel = this.selectedOptions && this.selectedOptions[0];
        if (!sel || !sel.value) return;

        // Update the placeholder text to reflect the chosen route, but keep the option list intact
        const placeholder = this.querySelector('option[hidden]');
        if (placeholder) {
            try { placeholder.hidden = true; placeholder.disabled = true; placeholder.selected = false; } catch (e) {}
        }
        // Force the select to display the chosen option: set selectedIndex to the option's index
        try {
            const opts = Array.from(this.options || []);
            const idx = opts.indexOf(sel);
            if (idx >= 0) {
                this.selectedIndex = idx;
            } else {
                // fallback: set value
                this.value = sel.value;
            }
        } catch (e) {
            try { this.value = sel.value; } catch (err) {}
        }
        console.log('[troop] destino change - selected value:', this.value, 'selectedIndex:', this.selectedIndex);
    });
    // Quando o usuário altera texto da partida, restaurar placeholder no destino (etapa 1)
    if (partidaInput) {
        partidaInput.addEventListener('input', function() {
            const select = document.getElementById('destino');
            if (!select) return;
            select.innerHTML = '';
            const ph = document.createElement('option'); ph.value=''; ph.disabled=true; ph.selected=true; ph.hidden=true; ph.textContent='Escolha a rota'; select.appendChild(ph);
            partidaCoords = null; // reset coords until place selected or geocoded
        });

        // If user leaves the partida field (blur), try to update destinos (will geocode if needed)
        partidaInput.addEventListener('blur', function() {
            // slight delay to allow place_changed to run first if applicable
            setTimeout(() => {
                updateDestinoOptions().catch(() => {});
            }, 150);
        });
    }

    // Listeners equivalentes para os campos da etapa-2 (results-origin/results-destino)
    const resultsDestinoSelect = document.getElementById('results-destino');
    if (resultsDestinoSelect) {
        resultsDestinoSelect.addEventListener('focus', function() {
            updateDestinoOptionsFor(resultsOriginInput || partidaInput, resultsDestinoSelect, autocompleteResults || autocomplete)
                .catch(() => {});
        });
        resultsDestinoSelect.addEventListener('change', function () {
            const sel = this.selectedOptions && this.selectedOptions[0];
            if (!sel || !sel.value) return;

            const placeholder = this.querySelector('option[hidden]');
            if (placeholder) {
                try { placeholder.hidden = true; placeholder.disabled = true; placeholder.selected = false; } catch (e) {}
            }
            try {
                const opts = Array.from(this.options || []);
                const idx = opts.indexOf(sel);
                if (idx >= 0) {
                    this.selectedIndex = idx;
                } else {
                    this.value = sel.value;
                }
            } catch (e) {
                try { this.value = sel.value; } catch (err) {}
            }
            console.log('[troop] results destino change - selected value:', this.value, 'selectedIndex:', this.selectedIndex);
        });
    }

    if (resultsOriginInput) {
        resultsOriginInput.addEventListener('blur', function () {
            setTimeout(() => {
                updateDestinoOptionsFor(resultsOriginInput, resultsDestinoSelect, autocompleteResults)
                    .catch(() => {});
            }, 150);
        });
    }

    // Skeleton de loading na barra lateral enquanto buscamos motoristas
    function showDriversSkeleton(count = 3) {
        const listEl = document.getElementById('drivers-list');
        const countEl = document.getElementById('drivers-count');
        if (!listEl) return;
        if (countEl) countEl.textContent = '';

        const skeletonCard = `
            <div class="w-full bg-troop-white rounded-xl border border-gray-100 shadow-sm p-3 flex gap-3 items-center animate-pulse">
                <div class="flex-shrink-0">
                    <div class="h-10 w-10 rounded-full bg-gray-200"></div>
                </div>
                <div class="flex-1 space-y-2">
                    <div class="flex items-center justify-between gap-2">
                        <div class="h-3 w-24 bg-gray-200 rounded"></div>
                        <div class="h-3 w-16 bg-gray-200 rounded"></div>
                    </div>
                    <div class="h-3 w-32 bg-gray-200 rounded"></div>
                    <div class="h-3 w-20 bg-gray-200 rounded"></div>
                </div>
            </div>
        `;

        listEl.innerHTML = new Array(count).fill(skeletonCard).join('');
    }

    // Estado de filtro da lista de motoristas ("", "cheapest", "rating", "seats")
    let activeDriverFilter = "";

    // Renderiza os cards de motoristas no dashboard de comparação
    function renderMotoristas() {
        const listEl = document.getElementById('drivers-list');
        const countEl = document.getElementById('drivers-count');
        if (!listEl) return;

        listEl.innerHTML = "";

        // Nenhuma rota retornada: mostra estado vazio amigável
        if (!motoristasPorRota || motoristasPorRota.length === 0) {
            if (countEl) countEl.textContent = '';
            listEl.innerHTML = `
                <div class="h-full flex flex-col items-center justify-center text-center text-muted-foreground px-4">
                    <div class="mb-3 flex h-16 w-16 items-center justify-center rounded-full bg-troop-light-gray">
                        <svg class="h-8 w-8 text-troop-purple" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13" rx="2" ry="2"/><path d="M16 8h4a2 2 0 0 1 2 2v6"/><path d="M3 21h18"/><path d="M6 18h.01"/><path d="M10 18h.01"/></svg>
                    </div>
                    <p class="text-sm font-medium text-troop-dark-gray mb-1">Ainda não temos vans para essa rota.</p>
                    <p class="text-xs text-muted-foreground">Que tal sugerir uma nova?</p>
                </div>
            `;
            return;
        }

        // Flatten: cada rota pode ter um ou mais motoristas (normalmente 1)
        let items = [];
        motoristasPorRota.forEach((rotaObj, rotaIdx) => {
            rotaObj.motoristas.forEach((motorista, mIdx) => {
                const price = typeof motorista.preco === 'number' ? motorista.preco : null;
                const seats = typeof motorista.vagas === 'number' ? motorista.vagas : null;
                const rating = typeof motorista.nota === 'number' ? motorista.nota : null;
                const dist = typeof rotaObj.distKm === 'number' ? rotaObj.distKm : null;
                items.push({ rotaIdx, mIdx, rotaObj, motorista, price, seats, rating, dist });
            });
        });

        // Ordenação principal por proximidade (distância da casa do usuário), com filtros como critério secundário
        function sortByDistanceThen(extraComparator) {
            items.sort((a, b) => {
                const da = a.dist ?? Number.POSITIVE_INFINITY;
                const db = b.dist ?? Number.POSITIVE_INFINITY;
                if (da !== db) return da - db;
                if (typeof extraComparator === 'function') return extraComparator(a, b);
                return 0;
            });
        }

        if (activeDriverFilter === 'cheapest') {
            sortByDistanceThen((a, b) => {
                const pa = a.price ?? Number.POSITIVE_INFINITY;
                const pb = b.price ?? Number.POSITIVE_INFINITY;
                return pa - pb;
            });
        } else if (activeDriverFilter === 'rating') {
            sortByDistanceThen((a, b) => {
                const ra = a.rating ?? 0;
                const rb = b.rating ?? 0;
                return rb - ra;
            });
        } else if (activeDriverFilter === 'seats') {
            sortByDistanceThen((a, b) => {
                const sa = a.seats ?? 0;
                const sb = b.seats ?? 0;
                return sb - sa;
            });
        } else {
            sortByDistanceThen();
        }

        if (countEl) countEl.textContent = `${items.length} opção${items.length === 1 ? '' : 'es'}`;

        items.forEach(({ rotaIdx, mIdx, rotaObj, motorista, price, seats, rating }) => {
            const displayPrice = price != null ? `R$ ${price.toFixed(2)}` : 'Preço a combinar';
            const displaySeats = seats != null ? `${seats} vaga${seats === 1 ? '' : 's'} disponíveis` : 'Vagas sob consulta';
            const displayRating = rating != null ? rating.toFixed(1) : 'N/A';
            const displayDist = typeof rotaObj.distKm === 'number' ? `${rotaObj.distKm.toFixed(1)} km da sua casa` : '';

            const trips = Array.isArray(rotaObj.trips) ? rotaObj.trips : [];
            const tripsCount = trips.length;
            const nextTrip = tripsCount ? trips[0] : null;
            let nextTripLabel = '';
            if (nextTrip && nextTrip.scheduledTime) {
                try {
                    const dt = new Date(nextTrip.scheduledTime);
                    nextTripLabel = dt.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                } catch (e) {}
            }

            const card = document.createElement('button');
            card.type = 'button';
            card.className = "driver-card w-full text-left bg-troop-white rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition-shadow p-3 flex gap-3 items-center";
            card.setAttribute('data-rota-idx', String(rotaIdx));
            card.setAttribute('data-motorista-idx', String(mIdx));

            card.innerHTML = `
                <div class="flex-shrink-0">
                    <div class="h-10 w-10 rounded-full overflow-hidden border-2" style="border-color:${rotaObj.cor}">
                        <img src="${motorista.foto}" alt="${motorista.nome}" class="h-full w-full object-cover" />
                    </div>
                </div>
                <div class="flex-1 flex flex-col gap-1 min-w-0">
                    <div class="flex items-center justify-between gap-2">
                        <span class="font-semibold text-xs md:text-sm text-troop-dark-gray truncate">${motorista.nome}</span>
                        <span class="text-xs md:text-sm font-bold text-troop-purple whitespace-nowrap">${displayPrice}</span>
                    </div>
                    <div class="flex items-center justify-between gap-2">
                        <div class="flex flex-col gap-0.5 text-[11px] text-muted-foreground truncate">
                            <div class="flex items-center gap-1 truncate">
                                <span class="inline-flex h-2 w-2 rounded-full" style="background:${rotaObj.cor}"></span>
                                <span class="truncate">${rotaObj.rota}</span>
                            </div>
                            ${displayDist ? `<span class="truncate">${displayDist}</span>` : ''}
                        </div>
                        <div class="flex items-center gap-1 text-[11px] text-amber-500">
                            ${[1,2,3,4,5].map(i => `<svg class="h-3 w-3 ${rating && rating >= i ? '' : 'opacity-30'}" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" fill=\"currentColor\"><polygon points=\"12 2 15 9 22 9 17 14 19 21 12 17 5 21 7 14 2 9 9 9 12 2\"/></svg>`).join('')}
                            <span class="text-[10px] ml-1 text-muted-foreground">${displayRating}</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between gap-2 mt-0.5">
                        <span class="text-[11px] text-muted-foreground truncate">${displaySeats}</span>
                        <span class="text-[11px] font-semibold text-troop-purple">${tripsCount > 1 ? `${tripsCount} horários · Ver todos` : 'Ver detalhes'}</span>
                    </div>
                    ${tripsCount ? `
                    <div class="mt-1 text-[11px] text-muted-foreground">
                        ${nextTripLabel ? `Próxima viagem hoje às <span class="font-semibold text-troop-dark-gray">${nextTripLabel}</span>` : ''}
                    </div>
                    <div id="trips-for-${rotaIdx}-${mIdx}" class="mt-1 space-y-1 hidden">
                        ${trips.map((t, idx) => {
                            let label = '';
                            try {
                                const dt = new Date(t.scheduledTime);
                                label = dt.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                            } catch (e) {}
                            const vagas = typeof t.seatsAvailable === 'number'
                                ? `${t.seatsAvailable} vaga${t.seatsAvailable === 1 ? '' : 's'}`
                                : '';
                            return `<div class=\"flex items-center justify-between border border-gray-100 rounded px-2 py-1 bg-gray-50\">
                                        <span>${label}</span>
                                        <span class=\"text-xs text-troop-purple font-semibold\">${vagas}</span>
                                    </div>`;
                        }).join('')}
                    </div>
                    ` : ''}
                </div>
            `;

            card.addEventListener('click', function() {
                // Ao clicar no card, destaca apenas a rota selecionada e expande/contrai a lista de viagens (se houver)
                highlightRouteOnMap(rotaIdx, mIdx);
                const tripsEl = document.getElementById(`trips-for-${rotaIdx}-${mIdx}`);
                if (tripsEl) {
                    tripsEl.classList.toggle('hidden');
                }
            });

            listEl.appendChild(card);
        });
    }

    // Cada motorista tem sua rota traçada no mapa ao clicar, usando apenas dados reais vindos do backend
    let activeRouteRenderers = [];
    let activeRouteMarkers = [];

    function clearActiveRoutesFromMap() {
        try {
            activeRouteRenderers.forEach(r => r.setMap(null));
            activeRouteRenderers = [];
            activeRouteMarkers.forEach(m => m.setMap(null));
            activeRouteMarkers = [];
        } catch (e) {}
    }

    function ensureBaseMap() {
        if (map && directionsService) return;
        const defaultCenter = partidaCoords
            || (motoristasPorRota[0] && motoristasPorRota[0].origem)
            || { lat: -31.7654, lng: -52.3371 };
        const defaultZoom = partidaCoords ? 14 : 12;

        map = new google.maps.Map(document.getElementById("map"), {
            center: defaultCenter,
            zoom: defaultZoom,
        });
        directionsService = new google.maps.DirectionsService();

        // Círculo de 1km e marcador apenas se o usuário informou partida
        if (partidaCoords) {
            const circle = new google.maps.Circle({
                strokeColor: '#322275',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#322275',
                fillOpacity: 0.1,
                map: map,
                center: partidaCoords,
                radius: 1000
            });

            const bounds = circle.getBounds();
            map.fitBounds(bounds);
            setTimeout(() => { map.setZoom(14); }, 100);

            const homeMarker = new google.maps.Marker({
                position: partidaCoords,
                map: map,
                title: "Sua casa",
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 10,
                    fillColor: '#322275',
                    fillOpacity: 1,
                    strokeColor: '#FFFFFF',
                    strokeWeight: 3
                }
            });
            activeRouteMarkers.push(homeMarker);
        }

        const recenterBtn = document.getElementById('btn-recentralizar');
        if (recenterBtn) {
            recenterBtn.onclick = function(e) {
                e.preventDefault();
                const center = partidaCoords
                    || (motoristasPorRota[0] && motoristasPorRota[0].origem)
                    || { lat: -31.7654, lng: -52.3371 };
                map.setCenter(center);
                map.setZoom(partidaCoords ? 14 : 12);
            };
        }
    }

    function inicializarMapaERotas() {
        ensureBaseMap();
        // No carregamento inicial, mostramos apenas o mapa base; as rotas são desenhadas
        // conforme o usuário clica nos cards (highlightRouteOnMap).
        adicionarLegendaVans();
    }

    // Adiciona legenda das vans no mapa
    function adicionarLegendaVans() {
        if (!motoristasPorRota || motoristasPorRota.length === 0) return;
        // Remove legenda anterior se existir
        const oldLegend = document.getElementById('map-legend');
        if (oldLegend) oldLegend.remove();

        const legend = document.createElement('div');
        legend.id = 'map-legend';
        legend.className = 'absolute bottom-6 left-6 bg-white/90 rounded-xl shadow-lg p-4 text-left z-50';
        legend.style.maxWidth = '320px';

        legend.innerHTML = `
            <div class="font-bold mb-2 text-troop-dark-gray">Legenda das Vans</div>
            ${motoristasPorRota.map((rotaObj, idx) => `
                <div class="flex items-center mb-1">
                    <span class="inline-block h-4 w-4 rounded-full mr-2" style="background:${rotaObj.cor}"></span>
                    <span class="font-semibold">${rotaObj.motoristas.map(m => m.nome).join(', ')}</span>
                </div>
            `).join('')}
        `;
        // Adiciona legenda dentro do container do mapa do dashboard
        const shell = document.getElementById('results-map-shell');
        (shell || document.body).appendChild(legend);
    }

    // Destaque de rota no mapa ao clicar no card
    function highlightRouteOnMap(rotaIdx, mIdx) {
        if (!motoristasPorRota[rotaIdx]) return;
        ensureBaseMap();

        clearActiveRoutesFromMap();

        const rota = motoristasPorRota[rotaIdx];
        const motorista = rota && rota.motoristas[mIdx];
        if (!rota || !motorista || !rota.origem || !rota.destino) return;

        // Desenha apenas a rota selecionada, com paradas reais como waypoints
        const renderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: true,
            polylineOptions: {
                strokeColor: '#322275',
                strokeOpacity: 0.95,
                strokeWeight: 6
            }
        });
        activeRouteRenderers.push(renderer);

        const waypoints = Array.isArray(rota.stops)
            ? rota.stops
                .filter(s => s && isFinite(Number(s.lat)) && isFinite(Number(s.lng)))
                .map(s => ({
                    location: { lat: Number(s.lat), lng: Number(s.lng) },
                    stopover: true
                }))
            : [];

        directionsService.route({
            origin: rota.origem,
            destination: rota.destino,
            waypoints,
            travelMode: google.maps.TravelMode.DRIVING
        }, function(response, status) {
            if (status === google.maps.DirectionsStatus.OK) {
                renderer.setDirections(response);

                const route = response.routes && response.routes[0];
                if (route && route.bounds) {
                    map.fitBounds(route.bounds);
                }

                const leg = route && route.legs && route.legs[0];
                const position = leg && leg.start_location ? leg.start_location : map.getCenter();

                // Marcador na origem da rota
                const originMarker = new google.maps.Marker({
                    position: rota.origem,
                    map: map,
                    title: `Início da rota - ${rota.rota}`,
                    icon: {
                        path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
                        scale: 6,
                        fillColor: rota.cor,
                        fillOpacity: 1,
                        strokeColor: '#FFFFFF',
                        strokeWeight: 2
                    }
                });
                activeRouteMarkers.push(originMarker);

                // Marcador no destino final
                const destMarker = new google.maps.Marker({
                    position: rota.destino,
                    map: map,
                    title: `Destino - ${rota.rota}`,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 10,
                        fillColor: '#f97316',
                        fillOpacity: 1,
                        strokeColor: '#FFFFFF',
                        strokeWeight: 3
                    }
                });
                activeRouteMarkers.push(destMarker);

                const price = typeof motorista.preco === 'number' ? `R$ ${motorista.preco.toFixed(2)}` : 'Preço a combinar';
                const seats = typeof motorista.vagas === 'number' ? `${motorista.vagas} vaga${motorista.vagas === 1 ? '' : 's'} disponíveis` : 'Vagas sob consulta';
                const rating = typeof motorista.nota === 'number' ? motorista.nota.toFixed(1) : 'N/A';

                if (!window._troopInfoWindow) {
                    window._troopInfoWindow = new google.maps.InfoWindow();
                }
                const html = `
                    <div style="padding:8px;max-width:240px;">
                        <div style="font-weight:600;color:#322275;margin-bottom:2px;">${motorista.nome}</div>
                        <div style="font-size:12px;margin-bottom:2px;">${rota.rota}</div>
                        <div style="font-size:12px;margin-bottom:2px;"><strong>${price}</strong></div>
                        <div style="font-size:11px;margin-bottom:2px;">${seats}</div>
                        <div style="font-size:11px;color:#f59e0b;">Nota: ${rating}</div>
                    </div>
                `;
                window._troopInfoWindow.setContent(html);
                window._troopInfoWindow.setPosition(position);
                window._troopInfoWindow.open(map);
            }
        });

    }

    // Helpers de autenticação e busca
    function getAuthToken() {
        try {
            return localStorage.getItem('troop_token');
        } catch (err) {
            return null;
        }
    }

    function saveTempSearch(search) {
        try {
            sessionStorage.setItem('temp_search', JSON.stringify(search));
        } catch (err) {}
    }

    function readTempSearch() {
        try {
            const raw = sessionStorage.getItem('temp_search');
            if (!raw) return null;
            return JSON.parse(raw);
        } catch (err) {
            return null;
        }
    }

    async function fetchAndPopulateRoutes(origin, destination) {
        try {
            // Mostra skeleton na barra lateral enquanto buscamos as rotas
            showDriversSkeleton();
            // Tenta usar apiGetRoutes (com autenticação) e cai para troopApi.fetchRoutes como fallback
            let activeSearch = null;
            try {
                const raw = sessionStorage.getItem('active_search');
                if (raw) activeSearch = JSON.parse(raw);
            } catch (e) {}

            const date = activeSearch && activeSearch.date ? activeSearch.date : undefined;

            // apiGetRoutes retorna { routes } enquanto troopApi.fetchRoutes retorna diretamente o JSON
            let resp;
            if (window.apiGetRoutes) {
                resp = await window.apiGetRoutes({ origin, destination, date });
            } else if (window.troopApi && typeof window.troopApi.fetchRoutes === 'function') {
                resp = await window.troopApi.fetchRoutes({ origin, destination, date });
            } else {
                throw new Error('API de rotas não está carregada');
            }

            let routesList = [];
            if (Array.isArray(resp)) routesList = resp;
            else if (resp.routes) routesList = resp.routes;

            // Filtro por destino final selecionado (por ID da rota ou texto), para grandes volumes
            let selectedRouteId = activeSearch && typeof activeSearch.destinationRouteId === 'number'
                ? activeSearch.destinationRouteId
                : null;
            const selectedDestinationLabel = activeSearch && typeof activeSearch.destination === 'string'
                ? activeSearch.destination.trim().toLowerCase()
                : '';

            if (selectedRouteId) {
                routesList = routesList.filter(r => Number(r.id) === Number(selectedRouteId));
            } else if (selectedDestinationLabel) {
                routesList = routesList.filter(r => {
                    const dest = (r.destination || '').trim().toLowerCase();
                    return dest === selectedDestinationLabel;
                });
            }

            // Coordenadas da casa do usuário para cálculo de proximidade
            let userLat = null, userLng = null;
            if (activeSearch && typeof activeSearch.originLat === 'number' && typeof activeSearch.originLng === 'number') {
                userLat = activeSearch.originLat;
                userLng = activeSearch.originLng;
            } else if (partidaCoords && typeof partidaCoords.lat === 'number' && typeof partidaCoords.lng === 'number') {
                userLat = partidaCoords.lat;
                userLng = partidaCoords.lng;
            }

            const userLatLng = (userLat != null && userLng != null && window.google && google.maps)
                ? new google.maps.LatLng(userLat, userLng)
                : null;

            // Mapear rotas do backend para o formato esperado pelo frontend (motoristasPorRota)
            const colors = ['#2563eb','#22c55e','#a21caf','#ff7f50','#f59e0b'];
            motoristasPorRota.length = 0;

            routesList.forEach((r, i) => {
                const totalSeats = typeof r.seatCapacity === 'number' ? r.seatCapacity : null;
                const booked = Array.isArray(r.bookings) ? r.bookings.length : 0;
                const availableSeats = totalSeats != null ? Math.max(0, totalSeats - booked) : null;

                const originLat = (r.originLat || r.origin?.lat);
                const originLng = (r.originLng || r.origin?.lng);
                let distKm = null;
                if (userLatLng && originLat != null && originLng != null) {
                    try {
                        if (google.maps.geometry && google.maps.geometry.spherical && typeof google.maps.geometry.spherical.computeDistanceBetween === 'function') {
                            const routeLatLng = new google.maps.LatLng(Number(originLat), Number(originLng));
                            const meters = google.maps.geometry.spherical.computeDistanceBetween(userLatLng, routeLatLng);
                            distKm = meters / 1000;
                        } else {
                            distKm = haversineKm({ lat: userLat, lng: userLng }, { lat: Number(originLat), lng: Number(originLng) });
                        }
                    } catch (e) {
                        distKm = null;
                    }
                }

                const trips = Array.isArray(r.trips) ? r.trips : [];

                motoristasPorRota.push({
                    rota: r.destination || '',
                    cor: colors[i % colors.length],
                    origem: { lat: (r.originLat || r.origin?.lat) || -31.7654, lng: (r.originLng || r.origin?.lng) || -52.3371 },
                    destino: { lat: (r.destinationLat || r.destination?.lat) || -31.7800, lng: (r.destinationLng || r.destination?.lng) || -52.3400 },
                    stops: Array.isArray(r.stops) ? r.stops : [],
                    distKm,
                    trips,
                    motoristas: [ {
                        nome: r.driver?.name || `Motorista ${i+1}`,
                        foto: 'https://randomuser.me/api/portraits/lego/1.jpg',
                        veiculo: r.vehicle || 'Van',
                        placa: r.id ? `R${r.id}` : '---',
                        preco: typeof r.price === 'number' ? r.price : null,
                        vagas: availableSeats,
                        nota: typeof r.rating === 'number' ? r.rating : null
                    } ]
                });
            });
        } catch (err) {
            console.error('Erro ao buscar rotas:', err);
            alert('Não foi possível buscar rotas do servidor. Tente novamente em instantes.');
            throw err;
        }
    }

    function goToEtapa2() {
        const etapa1 = document.getElementById('etapa-1');
        const etapa2 = document.getElementById('etapa-2');
        if (etapa1 && etapa2) {
            etapa1.classList.add('hidden');
            etapa2.classList.remove('hidden');
        }
        try {
            const logoEl = document.getElementById('header-logo');
            const loginEl = document.getElementById('header-login');
            const mobileMenu = document.querySelector('.md\\:hidden');
            if (logoEl) logoEl.classList.add('hidden');
            if (loginEl) loginEl.classList.add('hidden');
            if (mobileMenu) mobileMenu.classList.add('hidden');
        } catch (err) { /* ignore */ }

        // Preenche os campos da barra de busca da etapa-2 com a busca ativa
        try {
            const resultsOriginInput = document.getElementById('results-origin');
            const resultsDestinoSelect = document.getElementById('results-destino');
            const originInput = document.getElementById('partida');
            const destinoSelect = document.getElementById('destino');

            let originVal = originInput && originInput.value ? originInput.value : '';
            let destinationVal = destinoSelect && destinoSelect.value ? destinoSelect.value : '';

            try {
                const rawActive = sessionStorage.getItem('active_search');
                if (rawActive) {
                    const active = JSON.parse(rawActive);
                    if (active && typeof active.originAddress === 'string' && active.originAddress) {
                        originVal = active.originAddress;
                    }
                    if (active && typeof active.destination === 'string' && active.destination) {
                        destinationVal = active.destination;
                    }
                }
            } catch (e) { /* ignore */ }

            if (resultsOriginInput && originVal) resultsOriginInput.value = originVal;
            if (resultsDestinoSelect && destinationVal) resultsDestinoSelect.value = destinationVal;
        } catch (e) { /* ignore */ }

        renderMotoristas();
        inicializarMapaERotas();
    }

    function restoreSearchFromSession() {
        const temp = readTempSearch();
        if (!temp) return;

        const originInput = document.getElementById('partida');
        const destinoSelect = document.getElementById('destino');
        const dateInput = document.getElementById('data');

        if (originInput && temp.origin) originInput.value = temp.origin;
        if (destinoSelect && temp.destination) destinoSelect.value = temp.destination;
        if (dateInput && temp.date) dateInput.value = temp.date;

        const token = getAuthToken();
        if (!token) return;

        fetchAndPopulateRoutes(temp.origin, temp.destination)
            .then(() => {
                goToEtapa2();
                try { sessionStorage.removeItem('temp_search'); } catch (err) {}
            })
            .catch(() => {
                // erros já foram tratados no fetchAndPopulateRoutes
            });
    }

    // Botão de buscar rotas
    document.getElementById('btn-etapa-1').onclick = async function(e) {
        e.preventDefault();
        const btn = document.getElementById('btn-etapa-1');
        const originInput = document.getElementById('partida');
        const destinoSelect = document.getElementById('destino');
        const dateInput = document.getElementById('data');

        const origin = originInput && originInput.value ? originInput.value.trim() : '';
        const destination = destinoSelect && destinoSelect.value ? destinoSelect.value : '';
        const date = dateInput && dateInput.value ? dateInput.value : '';

        // Validação básica de UX
        let invalid = false;
        if (originInput) originInput.classList.remove('border-red-500');
        if (destinoSelect) destinoSelect.classList.remove('border-red-500');

        if (!origin && originInput) {
            originInput.classList.add('border-red-500');
            originInput.focus();
            invalid = true;
        }
        if (!destination && destinoSelect) {
            destinoSelect.classList.add('border-red-500');
            if (!invalid) destinoSelect.focus();
            invalid = true;
        }
        if (invalid) {
            alert('Por favor, selecione um endereço de partida e uma rota antes de prosseguir.');
            return;
        }

        // Estado de carregamento no botão enquanto resolvemos geolocalização
        const originalHtml = btn ? btn.innerHTML : null;
        if (btn) {
            btn.disabled = true;
            btn.classList.add('opacity-70','cursor-not-allowed');
            btn.innerHTML = '<svg class="h-5 w-5 mr-2 animate-spin" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10" stroke-opacity="0.25"/><path d="M4 12a8 8 0 0 1 8-8" /></svg>Carregando...';
        }

        try {
            // Garante lat/lng usando o Autocomplete (partidaCoords) ou geocoding manual
            let coords = partidaCoords;
            if ((!coords || typeof coords.lat !== 'number' || typeof coords.lng !== 'number') && origin) {
                try {
                    coords = await geocodeAddress(origin);
                } catch (err) {
                    coords = null;
                }
            }

            const originLat = coords && typeof coords.lat === 'number' ? coords.lat : null;
            const originLng = coords && typeof coords.lng === 'number' ? coords.lng : null;

            const activeSearch = {
                originAddress: origin,
                originLat,
                originLng,
                destination,
                date: date || null,
                createdAt: new Date().toISOString()
            };

            try {
                sessionStorage.setItem('active_search', JSON.stringify(activeSearch));
            } catch (err) { /* ignore */ }

            // Mantém compatibilidade com o fluxo antigo baseado em temp_search
            saveTempSearch({ origin, destination, date });

            const token = getAuthToken();

            if (!token) {
                // Não logado: envia para login.html; após login, auth.js volta para index,
                // onde restoreSearchFromSession usará os dados para ir à etapa 2.
                window.location.href = 'login.html';
                return;
            }

            // Já logado: busca rotas reais e vai direto para a segunda tela
            await fetchAndPopulateRoutes(origin, destination);
            goToEtapa2();
        } finally {
            if (btn) {
                btn.disabled = false;
                btn.classList.remove('opacity-70','cursor-not-allowed');
                if (originalHtml !== null) btn.innerHTML = originalHtml;
            }
        }
    };

    // Submissão da barra de busca da etapa-2 (dashboard)
    const resultsSearchForm = document.getElementById('results-search-form');
    if (resultsSearchForm) {
        resultsSearchForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const originInput = document.getElementById('results-origin');
            const destinoSelect = document.getElementById('results-destino');
            const dateInput = document.getElementById('results-date');

            const origin = originInput && originInput.value ? originInput.value.trim() : '';
            const destination = destinoSelect && destinoSelect.value ? destinoSelect.value : '';
            const date = dateInput && dateInput.value ? dateInput.value : '';

            // Validação simples: origem e destino obrigatórios para nova busca
            if (!origin || !destination) {
                alert('Informe origem e destino para atualizar a busca.');
                return;
            }

            saveTempSearch({ origin, destination, date });
            try {
                await fetchAndPopulateRoutes(origin, destination);
                renderMotoristas();
                inicializarMapaERotas();
            } catch (err) {
                // erros já tratados dentro de fetchAndPopulateRoutes
            }
        });
    }

    // Show the inline login modal (tela de login/cadastro sobreposta)
    function showLoginModal() {
        const backdrop = document.getElementById('login-modal-backdrop');
        if (!backdrop) return;
        backdrop.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        const email = document.getElementById('login-email');
        if (email) email.focus();
    }

    function closeLoginModal() {
        const backdrop = document.getElementById('login-modal-backdrop');
        if (!backdrop) return;
        backdrop.classList.add('hidden');
        document.body.style.overflow = '';
    }

    // Called after successful modal login specifically quando o fluxo veio do botão "BUSCAR ROTAS"
    function finishModalLoginAndProceed() {
        closeLoginModal();
        document.getElementById('etapa-1').classList.add('hidden');
        document.getElementById('etapa-2').classList.remove('hidden');
        try {
            const logoEl = document.getElementById('header-logo');
            const loginEl = document.getElementById('header-login');
            const mobileMenu = document.querySelector('.md\\:hidden');
            if (logoEl) logoEl.classList.add('hidden');
            if (loginEl) loginEl.classList.add('hidden');
            if (mobileMenu) mobileMenu.classList.add('hidden');
        } catch (err) {}
        renderMotoristas();
        inicializarMapaERotas();
    }

    // Destination select is updated by `updateDestinoOptions` when focused or clicked.

    // Botão Login do header / estado logado
    try {
        const headerLogin = document.getElementById('header-login');
        if (headerLogin) {
            const hasToken = (function(){ try { return !!localStorage.getItem('troop_token'); } catch (err) { return false; } })();
            if (hasToken) {
                let userName = null;
                try { userName = localStorage.getItem('user_name'); } catch (err) {}
                headerLogin.textContent = userName || 'Minha conta';
                headerLogin.href = '#';
                headerLogin.addEventListener('click', function(e){ e.preventDefault(); });

                const parent = headerLogin.parentElement;
                if (parent) {
                    const logoutBtn = document.createElement('button');
                    logoutBtn.type = 'button';
                    logoutBtn.textContent = 'Sair';
                    logoutBtn.className = 'ml-2 border border-troop-white/70 text-troop-white bg-transparent hover:bg-troop-white/10 font-bold py-2 px-4 rounded-full text-sm';
                    logoutBtn.addEventListener('click', function(e){
                        e.preventDefault();
                        try {
                            localStorage.removeItem('troop_token');
                            localStorage.removeItem('troop_logged_in');
                            localStorage.removeItem('user_name');
                            localStorage.removeItem('troop_role');
                            sessionStorage.removeItem('temp_search');
                        } catch (err) {}
                        window.location.href = 'index.html';
                    });
                    parent.appendChild(logoutBtn);
                }
            } else {
                // Usuário não logado: abre tela de login/cadastro sobreposta
                headerLogin.addEventListener('click', function(e){
                    e.preventDefault();
                    loginFlowContext = 'header';
                    showLoginModal();
                });
            }
        }
    } catch (err) { /* ignore */ }

    // Botão selecionar plano
    document.querySelectorAll('.selecionar-plano').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            // Para planos, podemos apenas abrir a tela de login/cadastro sobreposta
            loginFlowContext = 'header';
            showLoginModal();
        });
    });

    // Wiring da tela de login/cadastro sobreposta
    try {
        const modalCloseBtn = document.getElementById('loginModalClose');
        const modalCancelBtn = document.getElementById('loginModalCancel');
        const tabLogin = document.getElementById('tab-login');
        const tabRegister = document.getElementById('tab-register');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');

        if (modalCloseBtn) modalCloseBtn.addEventListener('click', closeLoginModal);
        if (modalCancelBtn) modalCancelBtn.addEventListener('click', closeLoginModal);

        function setLoginMode(mode) {
            const isLogin = mode === 'login';
            if (!loginForm || !registerForm || !tabLogin || !tabRegister) return;
            if (isLogin) {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                tabLogin.classList.add('bg-troop-purple','text-troop-white','shadow-md');
                tabRegister.classList.remove('bg-troop-purple','text-troop-white','shadow-md');
                tabRegister.classList.add('text-troop-dark-gray');
            } else {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                tabRegister.classList.add('bg-troop-purple','text-troop-white','shadow-md');
                tabLogin.classList.remove('bg-troop-purple','text-troop-white','shadow-md');
                tabLogin.classList.add('text-troop-dark-gray');
            }
        }

        if (tabLogin) tabLogin.addEventListener('click', function(e){ e.preventDefault(); setLoginMode('login'); });
        if (tabRegister) tabRegister.addEventListener('click', function(e){ e.preventDefault(); setLoginMode('register'); });

        // modo padrão quando o modal é carregado
        setLoginMode('login');
    } catch (err) { /* ignore */ }

    // Callback global utilizado por auth.js quando o login é feito no modal desta página
    window.handleLoginSuccess = async function(data) {
        const temp = readTempSearch();
        const cameFromSearch = (loginFlowContext === 'buscar');
        loginFlowContext = null;

        // Sempre reaproveita o que estiver em temp_search nos campos da etapa 1,
        // mesmo que o usuário tenha clicado em BUSCAR com campos vazios ou parciais.
        const originInput = document.getElementById('partida');
        const destinoSelect = document.getElementById('destino');
        const dateInput = document.getElementById('data');

        if (temp) {
            if (originInput && typeof temp.origin === 'string') originInput.value = temp.origin;
            if (destinoSelect && typeof temp.destination === 'string') destinoSelect.value = temp.destination;
            if (dateInput && typeof temp.date === 'string') dateInput.value = temp.date;
        }

        // Só seguimos automaticamente para a etapa 2 se o fluxo veio do botão BUSCAR
        // e se origem/destino estiverem preenchidos.
        if (cameFromSearch && temp && temp.origin && temp.destination) {
            closeLoginModal();
            try {
                await fetchAndPopulateRoutes(temp.origin, temp.destination);
                goToEtapa2();
                try { sessionStorage.removeItem('temp_search'); } catch (err) {}
            } catch (err) {
                // erros já foram tratados em fetchAndPopulateRoutes
            }
        } else {
            // Sem origem/destino completos: apenas fecha o modal e mantém o usuário na etapa 1
            // com os campos já restaurados (mesmo que vazios ou parciais).
            closeLoginModal();
        }
    };

    // Restaura busca temporária apenas se veio de login.html
    try {
        const fromLogin = sessionStorage.getItem('from_login');
        if (fromLogin === '1') {
            restoreSearchFromSession();
            sessionStorage.removeItem('from_login');
        } else {
            // Se não veio da tela de login, limpa qualquer busca temporária ao recarregar
            sessionStorage.removeItem('temp_search');
        }
    } catch (err) {}
});
</script>

    <!-- Tela de Login/Cadastro sobreposta -->
    <div id="login-modal-backdrop" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm px-4">
        <div class="w-full max-w-md bg-white/90 backdrop-blur-xl rounded-3xl shadow-strong p-8 md:p-10 relative">
            <button id="loginModalClose" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-lg" aria-label="Fechar">✕</button>
            <!-- Logo / Brand -->
            <div class="flex flex-col items-center mb-8">
                <div class="h-14 w-14 bg-troop-white rounded-3xl shadow-2xl flex items-center justify-center mb-3">
                    <img src="https://img.icons8.com/?size=100&id=QTQ1x0Wu6rnn&format=png&color=000000" alt="Van Escolar" class="h-10 w-10 object-contain drop-shadow-xl" />
                </div>
                <span class="font-horizon font-black text-3xl text-troop-purple tracking-wide">Troop</span>
                <p class="mt-2 text-sm text-muted-foreground text-center">Faça login ou crie sua conta para continuar.</p>
            </div>

            <!-- Tabs / Toggle -->
            <div class="flex mb-6 bg-troop-light-gray rounded-full p-1">
                <button id="tab-login" class="flex-1 py-2.5 text-sm font-semibold rounded-full transition-all duration-200 bg-troop-purple text-troop-white shadow-md">Entrar</button>
                <button id="tab-register" class="flex-1 py-2.5 text-sm font-semibold rounded-full transition-all duration-200 text-troop-dark-gray">Criar Conta</button>
            </div>

            <!-- Login form -->
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-xs font-semibold text-troop-dark-gray mb-1">E-mail</label>
                    <input id="login-email" type="email" required placeholder="seu@email.com" class="w-full border-2 border-muted rounded-lg px-4 py-3 text-sm text-troop-dark-gray focus:outline-none focus:border-troop-purple focus:ring-0 transition" />
                </div>
                <div>
                    <label for="login-password" class="block text-xs font-semibold text-troop-dark-gray mb-1">Senha</label>
                    <input id="login-password" type="password" required placeholder="Sua senha" class="w-full border-2 border-muted rounded-lg px-4 py-3 text-sm text-troop-dark-gray focus:outline-none focus:border-troop-purple focus:ring-0 transition" />
                </div>
                <div class="flex items-center justify-between text-xs mb-1">
                    <span class="text-muted-foreground">Esqueceu sua senha?</span>
                    <a href="#" class="text-troop-purple hover:underline">Recuperar acesso</a>
                </div>
                <button type="submit" class="w-full bg-troop-purple text-troop-white font-bold py-3 rounded-xl text-sm shadow-lg transform transition-all duration-200 hover:bg-troop-purple/90 hover:scale-[1.02]">Entrar</button>
            </form>

            <!-- Register form -->
            <form id="register-form" class="space-y-4 hidden mt-1">
                <div>
                    <label for="reg-name" class="block text-xs font-semibold text-troop-dark-gray mb-1">Nome completo</label>
                    <input id="reg-name" type="text" required placeholder="Seu nome" class="w-full border-2 border-muted rounded-lg px-4 py-3 text-sm text-troop-dark-gray focus:outline-none focus:border-troop-purple focus:ring-0 transition" />
                </div>
                <div>
                    <label for="reg-email" class="block text-xs font-semibold text-troop-dark-gray mb-1">E-mail</label>
                    <input id="reg-email" type="email" required placeholder="seu@email.com" class="w-full border-2 border-muted rounded-lg px-4 py-3 text-sm text-troop-dark-gray focus:outline-none focus:border-troop-purple focus:ring-0 transition" />
                </div>
                <div>
                    <label for="reg-password" class="block text-xs font-semibold text-troop-dark-gray mb-1">Senha</label>
                    <input id="reg-password" type="password" required placeholder="Crie uma senha segura" class="w-full border-2 border-muted rounded-lg px-4 py-3 text-sm text-troop-dark-gray focus:outline-none focus:border-troop-purple focus:ring-0 transition" />
                </div>
                <div>
                    <label for="reg-role" class="block text-xs font-semibold text-troop-dark-gray mb-1">Tipo de usuário</label>
                    <select id="reg-role" required class="w-full border-2 border-muted rounded-lg px-4 py-3 text-sm text-troop-dark-gray focus:outline-none focus:border-troop-purple focus:ring-0 transition bg-white">
                        <option value="" disabled selected hidden>Selecione uma opção</option>
                        <option value="passageiro">Passageiro</option>
                        <option value="motorista">Motorista</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-troop-purple text-troop-white font-bold py-3 rounded-xl text-sm shadow-lg transform transition-all duração-200 hover:bg-troop-purple/90 hover:scale-[1.02]">Criar conta</button>
            </form>

            <button id="loginModalCancel" type="button" class="mt-4 w-full text-center text-xs text-muted-foreground hover:text-troop-purple hover:underline">Cancelar</button>
        </div>
    </div>

    <!-- Troop frontend scripts -->
    <script type="module" src="js/api.js"></script>
    <script src="js/app.js"></script>
    <script type="module" src="js/auth.js"></script>
</body>
</html>